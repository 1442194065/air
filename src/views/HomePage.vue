<template>
    <div class="home">
        <div class="filters">
            <label for="city">选择城市：</label>
            <select v-model="city" @change="fetchWeatherData">
                <option v-for="cityName in cities" :key="cityName" :value="cityName">
                    {{ cityName }}
                </option>
            </select>
            <button @click="fetchWeatherData">获取天气数据</button>
        </div>

        <Weather v-if="weatherData" :data="weatherData" />

        <div class="chart-container" v-if="chartData.length">
            <div ref="chart" class="chart"></div>
        </div>
    </div>
</template>

<script setup>
    import { ref, onMounted,watch } from 'vue'
    import * as echarts from 'echarts'
    import Weather from '../components/AppWeather.vue'
    import axios from 'axios'

    const cities = ref(['shanghai', 'beijing', 'guangzhou', 'chengdu', 'shenzhen']) // 添加多个城市
    const city = ref(cities.value[0]) // 默认选择第一个城市
    const weatherData = ref(null)
    const chart = ref(null)
    const chartInstance = ref(null) // 保存图表实例
    const chartData = ref([])

    // 获取天气数据
    const fetchWeatherData = async () => {
        try {
            const response = await axios.get(`https://api.waqi.info/feed/${city.value}/?token=demo`)
            if (response.data.status === 'ok') {
                weatherData.value = response.data.data
                prepareChartData(response.data.data.forecast.daily)
            } else {
                alert('获取数据失败：' + response.data.message)
            }
        } catch (error) {
            console.error('请求失败:', error)
        }
    }

    // 监听 city 的变化，实时更新天气数据
    watch(city, () => {
        fetchWeatherData()
    })

    // 准备并渲染图表数据
    const prepareChartData = (forecast) => {
        chartData.value = [
            {
                name: 'PM2.5',
                data: forecast.pm25.map(day => ({ date: day.day, value: day.avg })),
            },
            {
                name: 'PM10',
                data: forecast.pm10.map(day => ({ date: day.day, value: day.avg })),
            },
            {
                name: 'O3',
                data: forecast.o3.map(day => ({ date: day.day, value: day.avg })),
            }
        ]
        renderChart(chartData.value)
    }
    

    const renderChart = (data) => {
        if (!chart.value) return

        // 如果图表实例存在，清除之前的实例
        if (chartInstance.value) {
            chartInstance.value.dispose()
            
        }

        chartInstance.value = echarts.init(chart.value) // 重新初始化图表

        const dates = data[0].data.map(item => item.date) // 统一取日期
        const series = data.map(item => ({
            name: item.name,
            type: 'line',
            smooth: true,
            data: item.data.map(point => point.value)
        }))
        
        const myChart = echarts.init(chart.value)

        const option = {
            title: {
                text: `${city.value} 空气质量数据`,
            },
            tooltip: {
                trigger: 'axis',
            },
            legend: {
                data: data.map(item => item.name),
            },
            xAxis: {
                type: 'category',
                data: dates,
            },
            yAxis: {
                type: 'value',
            },
            series: series,
        }

        myChart.setOption(option)
    }

    onMounted(() => {
        fetchWeatherData()
    })
</script>

<style scoped>
    .home {
        padding: 20px;
    }

    .filters {
        margin-bottom: 20px;
    }

    .chart-container {
        width: 100%;
        height: 400px;
    }

    .chart {
        width: 100%;
        height: 100%;
    }
</style>